<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impactful Customer Conversations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .feedback-card {
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(0.95) translateY(20px);
            opacity: 0;
        }
        .feedback-card.show {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: flex; /* Use flex for centering */
        }
        .highlight-e { background-color: #fef9c3; padding: 1px 3px; border-radius: 4px; font-weight: 500;}
        .highlight-p { background-color: #dbeafe; padding: 1px 3px; border-radius: 4px; font-weight: 500;}
        .highlight-s { background-color: #dcfce7; padding: 1px 3px; border-radius: 4px; font-weight: 500;}
        .highlight-o { background-color: #ede9fe; padding: 1px 3px; border-radius: 4px; font-weight: 500;}

        /* Welcome Screen Animation */
        .floating-element {
            position: fixed;
            will-change: transform;
            animation: float 25s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.07);
            font-weight: 500;
            color: #475569; /* slate-600 */
            z-index: 0;
            transition: transform 1s ease-in, opacity 1s ease-in; /* For exit animation */
        }

        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }
        
        /* Custom Dropdown */
        .custom-select-container {
            position: relative;
        }
        .select-chip {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .select-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
        }
        .select-options.open {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }
        .select-option {
            padding: 12px 16px;
            cursor: pointer;
        }
        .select-option:hover {
            background-color: #f1f5f9;
        }

    </style>
</head>
<body class="bg-slate-100">

    <div id="floating-elements-bg" class="fixed inset-0 z-0 overflow-hidden"></div>

    <div class="relative z-10 w-full max-w-4xl mx-auto my-8 p-4 flex items-center" style="min-height: 80vh;">
        
        <!-- Start Screen -->
        <div id="start-screen" class="screen active w-full text-center bg-white/80 backdrop-blur-lg p-8 md:p-16 rounded-2xl shadow-xl border border-slate-200 justify-center items-center flex-col">
            <div class="relative z-10">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800">Impactful Customer Conversations</h1>
                <p class="text-slate-600 mt-4 text-lg">Welcome to the EPSO Challenge!</p>
                <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="start-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 text-lg w-full sm:w-auto">
                        Start Group Challenge
                    </button>
                    <button id="view-all-time-leaderboard-btn" class="bg-white border-2 border-slate-300 text-slate-700 font-bold py-3 px-8 rounded-lg hover:bg-slate-100 transition-transform transform hover:scale-105 text-lg w-full sm:w-auto">
                        All-Time Leaderboard
                    </button>
                    <button id="view-data-btn" class="bg-white border-2 border-slate-300 text-slate-700 font-bold py-3 px-8 rounded-lg hover:bg-slate-100 transition-transform transform hover:scale-105 text-lg w-full sm:w-auto">
                        View Game Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen w-full justify-center items-center">
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full">
                <!-- Situation Display -->
                <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-lg mb-6">
                    <p class="font-semibold text-amber-800">Customer Message (<span id="progress-text"></span>):</p>
                    <p id="situation-text" class="text-amber-900 mt-1 font-medium"></p>
                </div>

                <!-- Agent Input -->
                <div class="space-y-4">
                    <div>
                        <label for="round-player-name" class="block text-sm font-medium text-slate-700 mb-2">Select Your Name:</label>
                        <div class="custom-select-container">
                            <div id="select-chip-button" class="select-chip w-full p-3 border border-slate-300 rounded-md bg-white flex justify-between items-center">
                                <span id="selected-name-text" class="text-slate-500">Select Your Name...</span>
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                                </svg>
                            </div>
                            <div id="select-options-list" class="select-options shadow-xl">
                                <!-- Options will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="agent-reply" class="block text-sm font-medium text-slate-700 mb-1">Your Reply:</label>
                        <textarea id="agent-reply" rows="5" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Type your best EPSO response here..."></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <button id="submit-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                        Rate My Reply
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Screen -->
        <div id="feedback-screen" class="screen w-full flex-col">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-slate-800">Reply Breakdown for <span id="feedback-player-name" class="text-indigo-600"></span></h2>
                <p class="text-slate-500">Score for this reply: <span id="reply-score" class="font-bold text-indigo-600"></span></p>
            </div>
            
            <div class="bg-slate-100 p-4 rounded-lg border border-slate-200 mb-6">
                <p class="text-sm font-semibold text-slate-600 mb-2">Your Reply with EPSO Highlights:</p>
                <div id="highlighted-reply" class="text-slate-800 whitespace-pre-wrap leading-relaxed"></div>
                <div class="flex flex-wrap gap-x-4 gap-y-2 mt-3 text-xs">
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-200 mr-1.5 border border-yellow-300"></span>Empathy</span>
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-200 mr-1.5 border border-blue-300"></span>Personalisation</span>
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-200 mr-1.5 border border-green-300"></span>Solution</span>
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-violet-200 mr-1.5 border border-violet-300"></span>Ownership</span>
                </div>
            </div>

            <div class="space-y-4">
                <div id="e-feedback" class="feedback-card flex items-start p-4 rounded-xl shadow bg-white"></div>
                <div id="p-feedback" class="feedback-card flex items-start p-4 rounded-xl shadow bg-white"></div>
                <div id="s-feedback" class="feedback-card flex items-start p-4 rounded-xl shadow bg-white"></div>
                <div id="o-feedback" class="feedback-card flex items-start p-4 rounded-xl shadow bg-white"></div>
            </div>
            <div class="mt-8 flex justify-center">
                <button id="next-btn" class="bg-slate-700 text-white font-bold py-3 px-8 rounded-lg hover:bg-slate-800 transition-transform transform hover:scale-105">
                    Next Situation
                </button>
            </div>
        </div>
        
        <!-- Leaderboard Screen (End Screen) -->
        <div id="leaderboard-screen" class="screen w-full justify-center items-center">
            <div class="bg-white p-8 md:p-12 rounded-2xl shadow-lg w-full">
                <h2 id="leaderboard-title" class="text-4xl font-extrabold text-slate-800 text-center"></h2>
                <p id="leaderboard-subtitle" class="text-center text-slate-500 mt-2 mb-8"></p>
                <div class="space-y-3" id="leaderboard-list">
                    <!-- Leaderboard items will be injected here -->
                </div>
                 <div id="leaderboard-buttons" class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                     <!-- Buttons will be injected here -->
                 </div>
            </div>
        </div>
        
        <!-- Data Screen -->
        <div id="data-screen" class="screen w-full justify-center items-center">
            <div class="bg-white p-8 md:p-12 rounded-2xl shadow-lg w-full">
                <h2 class="text-3xl font-extrabold text-slate-800 text-center">Game Data Log</h2>
                <p class="text-center text-slate-500 mt-2 mb-8">All recorded entries from every session.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Scenario #</th>
                                <th scope="col" class="px-6 py-3">Player</th>
                                <th scope="col" class="px-6 py-3">Reply</th>
                                <th scope="col" class="px-6 py-3 text-center">E</th>
                                <th scope="col" class="px-6 py-3 text-center">P</th>
                                <th scope="col" class="px-6 py-3 text-center">S</th>
                                <th scope="col" class="px-6 py-3 text-center">O</th>
                                <th scope="col" class="px-6 py-3 text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody id="data-log-table-body">
                            <!-- Data rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                 <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                     <button id="data-back-to-start-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 w-full sm:w-auto">Back to Start</button>
                     <button id="copy-csv-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 w-full sm:w-auto">Copy as CSV</button>
                     <button id="clear-all-data-btn" class="bg-red-100 border-2 border-red-200 text-red-700 font-bold py-3 px-8 rounded-lg hover:bg-red-200 transition-transform transform hover:scale-105 w-full sm:w-auto">Clear All Data</button>
                 </div>
            </div>
        </div>

    </div>

    <script>
        // DOM Elements
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            feedback: document.getElementById('feedback-screen'),
            leaderboard: document.getElementById('leaderboard-screen'),
            data: document.getElementById('data-screen'),
        };

        const startBtn = document.getElementById('start-btn');
        const viewAllTimeLeaderboardBtn = document.getElementById('view-all-time-leaderboard-btn');
        const viewDataBtn = document.getElementById('view-data-btn');
        const situationTextEl = document.getElementById('situation-text');
        
        // Custom Dropdown Elements
        const selectChipBtn = document.getElementById('select-chip-button');
        const selectedNameText = document.getElementById('selected-name-text');
        const selectOptionsList = document.getElementById('select-options-list');
        let selectedPlayerName = '';

        const agentReplyEl = document.getElementById('agent-reply');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const highlightedReplyEl = document.getElementById('highlighted-reply');
        
        // Game State
        let sessionScores = {};
        let currentSituationIndex = 0;
        let originalReplyText = '';
        
        const participants = [
            "Osama Khalid", "Erfan Abuhassan", "Ahmed Youssef", "Kim Del Mundo", "Cristelle Anne Ventucillo",
            "Salman Shafiqiue", "Haseeb Khan", "Hassan Miraj", "Momina Tasawar", "Mubashra Nazar", "Abdul Rehman",
            "Asma Imran", "Mohamed Zain", "Rand Mesmar", "Sewit Sium", "Houda Bouzidi", "Fayaz Mohammed"
        ];
        
        const situations = [
            { text: "I've been waiting for three days, and nobody has fixed my issue! This is the worst service ever.", keywords: ["three days", "3 days", "waiting", "fixed", "issue"] },
            { text: "Why do you people keep ignoring my messages? Do I need to call your CEO to get this resolved?", keywords: ["ignoring", "messages", "ceo", "resolved"] },
            { text: "Every time I renew my package, something goes wrong. I'm sick of this!", keywords: ["renew", "package", "every time", "wrong"] },
            { text: "Check the chat because I have been explaining again in every chat.", keywords: ["chat", "explaining", "again", "every"] },
            { text: "My payment was deducted, but I can't see the listing on my account.", keywords: ["payment", "deducted", "listing", "account"] },
            { text: "I specifically requested my ad to appear under Villas in Abu Dhabi, but it's showing under Apartments.", keywords: ["villas", "abu dhabi", "apartments", "showing"] },
            { text: "Hello, can you delete and unlink my number from this account. Thank you.", keywords: ["delete", "unlink", "number", "account"] },
            { text: "I posted it before, and it was live and not rejected. How come?", keywords: ["before", "live", "rejected", "how come"] },
            { text: "There was an advertisement that failed to be published. I need a refund.", keywords: ["advertisement", "failed", "published", "refund"] },
            { text: "My post was rejected due to duplication. However, I couldn't see my expired post to reactivate it. Please fix it or give me the option to advertise a new post.", keywords: ["rejected", "duplication", "expired", "reactivate", "new post"] },
            { text: "I'm trying to list an ad, but I cannot make a payment. I've tried to pay from 2 different banks, but the same error is showing.", keywords: ["payment", "pay", "banks", "error"] },
            { text: "I want to update my email address, but your colleague tells me I'm not allowed.", keywords: ["update", "email", "colleague", "not allowed"] }
        ];

        // --- Utility Functions ---
        const switchScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
             if (screenName === 'start') {
                createFloatingElements(); // Regenerate for next time
            }
        };

        function populateNameDropdown() {
            selectOptionsList.innerHTML = '';
            participants.forEach(name => {
                const option = document.createElement('div');
                option.className = 'select-option';
                option.dataset.value = name;
                option.textContent = name;
                option.addEventListener('click', () => {
                    selectedPlayerName = name;
                    selectedNameText.textContent = name;
                    selectedNameText.classList.remove('text-slate-500');
                    selectOptionsList.classList.remove('open');
                });
                selectOptionsList.appendChild(option);
            });
        }
        
        function createFloatingElements() {
            const container = document.getElementById('floating-elements-bg');
            if(!container) return;
            container.innerHTML = '';
            const elements = [
                ...participants,
                'â¤ï¸', 'â­', 'ðŸ‘', 'ðŸ’¬', 'ðŸ¤'
            ];
            elements.forEach((text, i) => {
                const el = document.createElement('div');
                el.className = 'floating-element';
                el.textContent = text;
                el.style.left = `${5 + Math.random() * 90}vw`;
                el.style.animationDuration = `${20 + Math.random() * 15}s`;
                el.style.animationDelay = `${Math.random() * 25}s`;
                el.style.fontSize = `${14 + Math.random() * 8}px`;
                el.style.transform = '';
                el.style.opacity = '';
                container.appendChild(el);
            });
        }
        
        // --- Game Logic ---
        function initiateGameStart() {
            const floatingElements = document.querySelectorAll('.floating-element');
            floatingElements.forEach(el => {
                const randomX = (Math.random() - 0.5) * 20; // -10 to +10 vw
                el.style.transform = `translateY(-110vh) translateX(${randomX}vw) rotate(180deg) scale(0.3)`;
                el.style.opacity = '0';
            });

            setTimeout(() => {
                startGame();
            }, 1000); // Wait 1 second for animation
        }

        function startGame() {
            sessionScores = {};
            currentSituationIndex = 0;
            loadSituation();
        }

        function loadSituation() {
            if (currentSituationIndex < situations.length) {
                situationTextEl.textContent = situations[currentSituationIndex].text;
                agentReplyEl.value = '';
                selectedPlayerName = '';
                selectedNameText.textContent = 'Select Your Name...';
                selectedNameText.classList.add('text-slate-500');
                document.getElementById('progress-text').textContent = `Scenario ${currentSituationIndex + 1} of ${situations.length}`;
                switchScreen('game');
            } else {
                endGame();
            }
        }
        
        function rateReply() {
            const playerName = selectedPlayerName;
            originalReplyText = agentReplyEl.value;
            const reply = originalReplyText.toLowerCase();

            if (!playerName) {
                alert('Please select your name for this round.');
                return;
            }
             if (reply.length < 10) {
                alert('Please provide a more detailed response.');
                return;
            }

            let scores = { e: 0, p: 0, s: 0, o: 0 };
            let feedback = {};
            
            const keywordSets = {
                e: ["frustrating", "understand", "imagine", "sorry to hear", "difficult", "annoying", "concern", "apologise"],
                p: situations[currentSituationIndex].keywords,
                s: ["solution", "fix", "resolve", "what we can do", "the reason is", "the next step", "you can", "to fix this", "investigate", "look into", "check with", "coordinate", "escalate", "find out what happened", "get to the bottom"],
                o: ["i will", "i'll", "personally", "myself", "i am", "i'm", "by ", "pm", "am", "today", "within", "hour", "soon as", "asap", "shortly", "immediately"]
            };

            if (keywordSets.e.some(word => reply.includes(word))) { scores.e = 25; feedback.e = { text: "Excellent empathy!", icon: 'â¤ï¸' };
            } else { feedback.e = { text: "Acknowledge the customer's frustration first.", icon: 'ðŸ’”' }; }

            if (keywordSets.p.some(key => reply.includes(key))) { scores.p = 25; feedback.p = { text: "Great personalisation!", icon: 'ðŸŽ¯' };
            } else { feedback.p = { text: `Mention a specific keyword from their message (e.g., '${keywordSets.p[0]}').`, icon: 'ðŸ§' }; }

            if (keywordSets.s.some(word => reply.includes(word))) { scores.s = 25; feedback.s = { text: "Good! You provided a clear path towards a solution.", icon: 'ðŸ’¡' };
            } else { feedback.s = { text: "Guide the customer to a solution or explain next steps.", icon: 'ðŸ¤”' }; }

            const ownActionWords = ["i will", "i'll", "personally", "myself", "i am", "i'm"];
            const timelineWords = ["by", "pm", "am", "today", "within", "hour", "soon as", "asap", "shortly", "immediately"];
            if (ownActionWords.some(word => reply.includes(word))) { scores.o += 15; }
            if (timelineWords.some(word => reply.includes(word))) { scores.o += 10; }
            
            if (scores.o >= 25) { feedback.o = { text: "Fantastic ownership! You took personal responsibility and committed to a follow-up.", icon: 'ðŸ¤' };
            } else if (scores.o >= 15) { feedback.o = { text: "Good ownership, but try adding a specific timeline.", icon: 'ðŸ‘' };
            } else { feedback.o = { text: "End with a strong statement of ownership (e.g., 'I will personally...').", icon: 'ðŸ‘Ž' }; }
            
            const replyScore = scores.e + scores.p + scores.s + scores.o;
            sessionScores[playerName] = (sessionScores[playerName] || 0) + replyScore;
            
            logGameData({
                scenarioIndex: currentSituationIndex,
                playerName: playerName,
                replyText: originalReplyText,
                scores: scores,
                totalScore: replyScore,
            });

            displayFeedback(playerName, scores, feedback, replyScore, keywordSets);
        }

        function highlightKeywords(text, keywords, className) {
            let highlightedText = text;
            const sortedKeywords = keywords.sort((a, b) => b.length - a.length);
            sortedKeywords.forEach(keyword => {
                const regex = new RegExp(`(\\b${keyword}[a-z]*\\b)`, 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="${className}">$1</span>`);
            });
            return highlightedText;
        }

        function displayFeedback(playerName, scores, feedback, replyScore, keywordSets) {
            document.getElementById('feedback-player-name').textContent = playerName;
            let highlightedHtml = originalReplyText;
            highlightedHtml = highlightKeywords(highlightedHtml, keywordSets.e, 'highlight-e');
            highlightedHtml = highlightKeywords(highlightedHtml, keywordSets.p, 'highlight-p');
            highlightedHtml = highlightKeywords(highlightedHtml, keywordSets.s, 'highlight-s');
            highlightedHtml = highlightKeywords(highlightedHtml, keywordSets.o, 'highlight-o');
            highlightedReplyEl.innerHTML = highlightedHtml;
            
            const feedbackMap = [
                { id: 'e-feedback', score: scores.e, data: feedback.e, letter: 'E - Empathise' },
                { id: 'p-feedback', score: scores.p, data: feedback.p, letter: 'P - Personalise' },
                { id: 's-feedback', score: scores.s, data: feedback.s, letter: 'S - Solution' },
                { id: 'o-feedback', score: scores.o, data: feedback.o, letter: 'O - Own' },
            ];
            
            feedbackMap.forEach((item, index) => {
                const el = document.getElementById(item.id);
                const scoreColor = item.score > 0 ? 'text-green-600' : 'text-slate-400';
                const bgColor = item.score > 0 ? 'bg-green-50' : 'bg-white';
                el.className = `feedback-card flex items-start p-4 rounded-xl shadow ${bgColor}`;
                el.innerHTML = `
                    <div class="mr-4 flex-shrink-0 text-2xl">${item.data.icon}</div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">${item.letter}</h3>
                            <p class="font-bold ${scoreColor}">+${item.score} pts</p>
                        </div>
                        <p class="text-slate-600 text-sm mt-1">${item.data.text}</p>
                    </div>
                `;
                setTimeout(() => el.classList.add('show'), index * 120);
            });
            
            document.getElementById('reply-score').textContent = `${replyScore} / 100`;
            switchScreen('feedback');
        }

        function endGame() {
            updateAllTimeScores();
            displaySessionLeaderboard();
        }

        // --- Data & Leaderboard Logic ---
        function getFromStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }
        
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function logGameData(entry) {
            const gameLog = getFromStorage('epsoGameLog') || [];
            gameLog.push(entry);
            saveToStorage('epsoGameLog', gameLog);
        }

        function updateAllTimeScores() {
            const allTimeScores = getFromStorage('epsoAllTimeScores') || {};
            for (const name in sessionScores) {
                allTimeScores[name] = (allTimeScores[name] || 0) + sessionScores[name];
            }
            saveToStorage('epsoAllTimeScores', allTimeScores);
        }
        
        function displayLeaderboard(title, subtitle, scores, buttons) {
            document.getElementById('leaderboard-title').textContent = title;
            document.getElementById('leaderboard-subtitle').textContent = subtitle;
            const boardArray = Object.entries(scores).map(([name, score]) => ({ name, score }));
            boardArray.sort((a, b) => b.score - a.score);

            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '';

            if (boardArray.length === 0) {
                listEl.innerHTML = '<p class="text-center text-slate-500">No scores recorded yet.</p>';
            } else {
                 boardArray.forEach((entry, index) => {
                    const rankIcons = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                    const icon = index < 3 ? `<span class="text-2xl">${rankIcons[index]}</span>` : `<span class="font-bold text-slate-500 text-lg w-6 text-center">${index + 1}</span>`;
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-4 rounded-lg bg-slate-100';
                    el.innerHTML = `
                        <div class="flex items-center space-x-4">
                            ${icon}
                            <p class="font-bold text-slate-700 text-lg">${entry.name}</p>
                        </div>
                        <p class="font-bold text-indigo-600 text-lg">${entry.score} pts</p>
                    `;
                    listEl.appendChild(el);
                });
            }

            const buttonsEl = document.getElementById('leaderboard-buttons');
            buttonsEl.innerHTML = buttons;
            attachLeaderboardButtonListeners();
            switchScreen('leaderboard');
        }

        function displaySessionLeaderboard() {
            const buttons = `<button id="restart-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 w-full sm:w-auto">Play Again</button>
                             <button id="view-all-time-leaderboard-btn-2" class="bg-white border-2 border-slate-300 text-slate-700 font-bold py-3 px-8 rounded-lg hover:bg-slate-100 transition-transform transform hover:scale-105 w-full sm:w-auto">View All-Time Scores</button>`;
            displayLeaderboard('Challenge Complete!', 'Here are the scores for this session.', sessionScores, buttons);
        }
        
        function displayAllTimeLeaderboard() {
             const buttons = `<button id="back-to-start-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 w-full sm:w-auto">Back to Start</button>`;
            displayLeaderboard('All-Time Leaderboard', 'Cumulative scores from all sessions.', getFromStorage('epsoAllTimeScores') || {}, buttons);
        }

        function displayGameData() {
            const log = getFromStorage('epsoGameLog') || [];
            const tbody = document.getElementById('data-log-table-body');
            tbody.innerHTML = '';
            if (log.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-slate-500">No game data has been recorded yet.</td></tr>';
            } else {
                log.forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b';
                    row.innerHTML = `
                        <td class="px-6 py-4">${entry.scenarioIndex + 1}</td>
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${entry.playerName}</th>
                        <td class="px-6 py-4 max-w-sm truncate" title="${entry.replyText}">${entry.replyText}</td>
                        <td class="px-6 py-4 text-center">${entry.scores.e}</td>
                        <td class="px-6 py-4 text-center">${entry.scores.p}</td>
                        <td class="px-6 py-4 text-center">${entry.scores.s}</td>
                        <td class="px-6 py-4 text-center">${entry.scores.o}</td>
                        <td class="px-6 py-4 text-center font-bold text-indigo-600">${entry.totalScore}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            switchScreen('data');
        }

        function copyDataAsCsv() {
            const log = getFromStorage('epsoGameLog') || [];
            if (log.length === 0) {
                alert('No data to copy.');
                return;
            }
            const headers = "Scenario #,Player,Reply,Empathy Score,Personalise Score,Solution Score,Ownership Score,Total Score";
            const csvContent = log.map(entry => {
                const reply = `"${entry.replyText.replace(/"/g, '""')}"`; // Escape double quotes
                return [
                    entry.scenarioIndex + 1,
                    entry.playerName,
                    reply,
                    entry.scores.e,
                    entry.scores.p,
                    entry.scores.s,
                    entry.scores.o,
                    entry.totalScore
                ].join(',');
            }).join('\n');
            
            const csv = `${headers}\n${csvContent}`;
            navigator.clipboard.writeText(csv).then(() => {
                const btn = document.getElementById('copy-csv-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy as CSV'; }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy data.');
            });
        }
        
        function attachLeaderboardButtonListeners() {
            const restartBtn = document.getElementById('restart-btn');
            if(restartBtn) restartBtn.addEventListener('click', () => switchScreen('start'));
            
            const viewAllTimeBtn2 = document.getElementById('view-all-time-leaderboard-btn-2');
            if(viewAllTimeBtn2) viewAllTimeBtn2.addEventListener('click', displayAllTimeLeaderboard);
            
            const backToStartBtn = document.getElementById('back-to-start-btn');
            if(backToStartBtn) backToStartBtn.addEventListener('click', () => switchScreen('start'));
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            populateNameDropdown();
            createFloatingElements();

            // --- Event Listeners ---
            startBtn.addEventListener('click', initiateGameStart);
            submitBtn.addEventListener('click', rateReply);
            nextBtn.addEventListener('click', () => {
                currentSituationIndex++;
                loadSituation();
            });
            viewAllTimeLeaderboardBtn.addEventListener('click', displayAllTimeLeaderboard);
            viewDataBtn.addEventListener('click', displayGameData);

            document.getElementById('data-back-to-start-btn').addEventListener('click', () => switchScreen('start'));
            document.getElementById('copy-csv-btn').addEventListener('click', copyDataAsCsv);
            document.getElementById('clear-all-data-btn').addEventListener('click', () => {
                 if(confirm('Are you sure you want to delete ALL saved scores and game data? This action cannot be undone.')) {
                    localStorage.removeItem('epsoAllTimeScores');
                    localStorage.removeItem('epsoGameLog');
                    displayGameData();
                }
            });
            
            selectChipBtn.addEventListener('click', () => {
                selectOptionsList.classList.toggle('open');
            });
            
            document.addEventListener('click', (e) => {
                if (!selectChipBtn.contains(e.target)) {
                    selectOptionsList.classList.remove('open');
                }
            });
        });

    </script>
</body>
</html>

